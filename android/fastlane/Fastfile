default_platform(:android)

platform :android do
  desc "Build and deploy Android app to Firebase and Play Store"
  lane :deploy do |options|
    env = options[:environment] || "dev"
    gradle_task = env == "prod" ? "assembleRelease" : "assembleDebug"
    firebase_app_id = options[:firebase_app_id] || ENV["FIREBASE_ANDROID_APP_ID"]
    skip_build =  "true"

    UI.message("ğŸš€ Deploying Android app for environment: #{env}")

    # Láº¥y version vÃ  build number
    version_number = get_android_version_number
    build_number = get_android_build_number

    # Cáº­p nháº­t version trong build.gradle.kts
    gradle_file_path = "../app/build.gradle.kts"
    gradle_content = File.read(gradle_file_path)
    
    # Cáº­p nháº­t versionName
    gradle_content = gradle_content.gsub(
      /versionName\s*=\s*"[^"]+"/,
      "versionName = \"#{version_number}\""
    )
    
    # Cáº­p nháº­t versionCode
    gradle_content = gradle_content.gsub(
      /versionCode\s*=\s*\d+/,
      "versionCode = #{build_number}"
    )
    
    File.write(gradle_file_path, gradle_content)

    unless skip_build
      begin
          gradle(task: gradle_task)
      rescue => e
          UI.error("âŒ Failed to build Android app: #{e.message}")
          return
      end
    else
      UI.message("â­ï¸ Bá» qua bÆ°á»›c build, dÃ¹ng artifact cÃ³ sáºµn")
    end

    apk_path = env == "prod" ? "../app/build/outputs/apk/release/app-release.apk" : "../app/build/outputs/apk/debug/app-debug.apk"

    # Log thÆ° má»¥c Ä‘áº§u ra Ä‘á»ƒ debug artifact
    begin
      UI.message("ğŸ“‚ Listing release dir: #{File.expand_path('../app/build/outputs/apk/release', __dir__)}")
      Dir.glob("../app/build/outputs/apk/release/**/*").each { |f| UI.message("  - #{f}") }
    rescue => e
      UI.message("âš ï¸ KhÃ´ng thá»ƒ liá»‡t kÃª release: #{e.message}")
    end
    begin
      UI.message("ğŸ“‚ Listing debug dir: #{File.expand_path('../app/build/outputs/apk/debug', __dir__)}")
      Dir.glob("../app/build/outputs/apk/debug/**/*").each { |f| UI.message("  - #{f}") }
    rescue => e
      UI.message("âš ï¸ KhÃ´ng thá»ƒ liá»‡t kÃª debug: #{e.message}")
    end

    unless File.exist?(apk_path)
        UI.error("âŒ KhÃ´ng tÃ¬m tháº¥y APK á»Ÿ #{apk_path}. Náº¿u skip build thÃ¬ cáº§n cung cáº¥p sáºµn file.")
        return
    end

    if firebase_app_id && File.exist?(apk_path)
        begin
            firebase_app_distribution(
              app: firebase_app_id,
              apk_path: apk_path,
              groups: "beta-testers",
              release_notes: "Deploying #{env} build - #{Time.now.strftime('%Y-%m-%d %H:%M:%S')}"
            )
            UI.success("Uploaded to Firebase App Distribution successfully âœ…")
        rescue => e
            UI.error("âŒ Failed to upload to Firebase: #{e.message}")
        end
    else
        UI.error("Firebase App ID not set or APK not found, skipping Firebase upload.")
    end

    json_key_file = "google-play-service-account.json"
    if env == "prod"
        begin
            supply(track: "production", apk: apk_path, json_key: json_key_file)
            UI.success("Uploaded to Play Store production track âœ…")
        rescue => e
            UI.error("âŒ Failed to upload to Play Store: #{e.message}")
        end
    else
        begin
            supply(track: "internal", apk: apk_path, json_key: json_key_file)
            UI.success("Uploaded to Play Store internal track âœ…")
        rescue => e
            UI.error("âŒ Failed to upload to Play Store: #{e.message}")
        end
    end

    UI.success("Android deploy lane completed ğŸ‰")
  end

  private_lane :get_android_version_number do 
    # Äá»c version tá»« build.gradle.kts
    gradle_path = "../app/build.gradle.kts"
    unless File.exist?(gradle_path)
      UI.error("âŒ build.gradle.kts not found")
      next nil
    end
  
    gradle_content = File.read(gradle_path)
    version_match = gradle_content.match(/versionName\s*=\s*"([^"]+)"/)
    
    if version_match
      version = version_match[1]
      UI.message("ğŸ“± Android Version from build.gradle: #{version}")
      next version
    else
      UI.error("âŒ Could not find versionName in build.gradle")
      next nil
    end
  end

  private_lane :get_android_build_number do 
    # Äá»c build number tá»« build.gradle.kts
    gradle_path = "../app/build.gradle.kts"
    unless File.exist?(gradle_path)
      UI.error("âŒ build.gradle.kts not found")
      next 1
    end
  
    gradle_content = File.read(gradle_path)
    build_match = gradle_content.match(/versionCode\s*=\s*(\d+)/)
    
    if build_match
      current_build = build_match[1].to_i
      new_build = current_build + 1
      UI.message("ğŸ“± Android Build number: #{new_build}")
      next new_build
    else
      UI.error("âŒ Could not find versionCode in build.gradle")
      next 1
    end
  end
end