name: Build & Deploy (on branch push with "deploy" in commit)

on:
  push:
    branches:
      - dev
      - staging
      - main
      - master
  workflow_dispatch:

env:
  FLUTTER_CHANNEL: stable
  FASTLANE_HIDE_TIMESTAMP: "true"
  FASTLANE_SKIP_UPDATE_CHECK: "true"
  FASTLANE_DEBUG: "true"

jobs:
  prepare:
    name: Prepare (common artifacts/cache)
    runs-on: [self-hosted, macos]
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      message: ${{ steps.check.outputs.message }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check commit message contains 'deploy'
        id: check
        run: |
          MSG="${{ github.event.head_commit.message || '' }}"
          echo "Commit: $MSG"
          if echo "$MSG" | grep -q "deploy"; then
            echo "::set-output name=should_run::true"
            echo "::set-output name=message::$MSG"
          else
            echo "::set-output name=should_run::false"
            echo "::set-output name=message::$MSG"
            echo "Commit message does not contain 'deploy' => skipping build/deploy"
          fi

      - name: Check Flutter installed
        if: steps.check.outputs.should_run == 'true'
        id: check_flutter
        run: |
          if command -v flutter &> /dev/null; then
            echo "flutter_installed=true" >> $GITHUB_OUTPUT
            echo "✓ Flutter đã được cài đặt sẵn trên runner"
          else
            echo "flutter_installed=false" >> $GITHUB_OUTPUT
            echo "⚠ Flutter chưa có trên runner"
          fi

      - name: Setup Flutter (from runner)
        if: steps.check.outputs.should_run == 'true' && steps.check_flutter.outputs.flutter_installed == 'true'
        run: |
          flutter --version
          flutter channel ${{ env.FLUTTER_CHANNEL }}
          flutter upgrade

      - name: Setup Flutter (download)
        if: steps.check.outputs.should_run == 'true' && steps.check_flutter.outputs.flutter_installed == 'false'
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Prepare env files, google play json & keystore
        if: steps.check.outputs.should_run == 'true'
        env:
          ENV_DEV_CONTENT: ${{ secrets.ENV_DEV_CONTENT }}
          ENV_STAGING_CONTENT: ${{ secrets.ENV_STAGING_CONTENT }}
          ENV_PROD_CONTENT: ${{ secrets.ENV_PROD_CONTENT }}
          GOOGLE_PLAY_JSON: ${{ secrets.GOOGLE_PLAY_JSON }}
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          mkdir -p lib/config

          echo "$ENV_DEV_CONTENT" > lib/config/.env.dev
          echo "$ENV_STAGING_CONTENT" > lib/config/.env.staging
          echo "$ENV_PROD_CONTENT" > lib/config/.env.prod

          if [[ -n "$GOOGLE_PLAY_JSON" ]]; then
            if [[ $(echo "$GOOGLE_PLAY_JSON" | tr -d '[:space:]' | cut -c1) == "{" ]]; then
              echo "$GOOGLE_PLAY_JSON" > google-play-service-account.json
            else
              cp "$GOOGLE_PLAY_JSON" google-play-service-account.json || true
            fi
          fi

          if [[ -n "$KEYSTORE_BASE64" ]]; then
            mkdir -p android/app
            echo "$KEYSTORE_BASE64" | base64 -d > android/app/app-release-key.jks

            echo "storePassword=$KEYSTORE_PASSWORD" > android/key.properties
            echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
            echo "keyAlias=$KEY_ALIAS" >> android/key.properties
            echo "storeFile=app-release-key.jks" >> android/key.properties
          fi

  # ============= DEV =============
  build-dev:
    name: Build (dev)
    needs: prepare
    environment: dev
    runs-on: [self-hosted, macos]
    if: needs.prepare.outputs.should_run == 'true' && github.ref == 'refs/heads/dev'
    steps:
      - uses: actions/checkout@v4
      - name: Check Flutter installed
        id: check_flutter
        run: |
          if command -v flutter &> /dev/null; then
            echo "flutter_installed=true" >> $GITHUB_OUTPUT
            echo "✓ Flutter đã được cài đặt sẵn trên runner"
          else
            echo "flutter_installed=false" >> $GITHUB_OUTPUT
            echo "⚠ Flutter chưa có trên runner"
          fi

      - name: Setup Flutter (from runner)
        if: steps.check_flutter.outputs.flutter_installed == 'true'
        run: |
          flutter --version
          flutter channel ${{ env.FLUTTER_CHANNEL }}
          flutter upgrade

      - name: Setup Flutter (download)
        if: steps.check_flutter.outputs.flutter_installed == 'false'
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - run: flutter pub get

      - name: Build
        run: |
          MSG="${{ needs.prepare.outputs.message }}"
          echo "Building for: $MSG"
          if echo "$MSG" | grep -q "android-ios"; then
            make build-appbundle-dev
            make build-android-dev
            make build-ipa-dev
          elif echo "$MSG" | grep -q "android"; then
            make build-appbundle-dev
            make build-android-dev
          elif echo "$MSG" | grep -q "ios"; then
            make build-ipa-dev
          else
            echo "No platform in commit message => skip"
            exit 0
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: build-dev-artifacts
          path: |
            build/app/outputs/**/*.aab
            build/app/outputs/**/*.apk
            build/ios/ipa/*.ipa

  deploy-dev:
    name: Deploy (dev)
    needs: build-dev
    environment: dev
    runs-on: [self-hosted, macos]
    if: needs.prepare.outputs.should_run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-dev-artifacts

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - run: gem install bundler && bundle install || true

      - name: Deploy via Fastlane
        env:
          ENVIRONMENT: dev
          FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          FIREBASE_IOS_APP_ID: ${{ secrets.FIREBASE_IOS_APP_ID }}
        run: |
          MSG="${{ needs.prepare.outputs.message }}"
          if echo "$MSG" | grep -q "android"; then
            cd android && bundle exec fastlane android deploy environment:dev
          fi
          if echo "$MSG" | grep -q "ios"; then
            cd ios && bundle exec fastlane ios deploy environment:dev
          fi

  # ============= STAGING =============
  build-staging:
    name: Build (staging)
    needs: prepare
    environment: staging
    runs-on: [self-hosted, macos]
    if: needs.prepare.outputs.should_run == 'true' && github.ref == 'refs/heads/staging'
    steps:
      - uses: actions/checkout@v4
      - name: Check Flutter installed
        id: check_flutter
        run: |
          if command -v flutter &> /dev/null; then
            echo "flutter_installed=true" >> $GITHUB_OUTPUT
            echo "✓ Flutter đã được cài đặt sẵn trên runner"
          else
            echo "flutter_installed=false" >> $GITHUB_OUTPUT
            echo "⚠ Flutter chưa có trên runner"
          fi

      - name: Setup Flutter (from runner)
        if: steps.check_flutter.outputs.flutter_installed == 'true'
        run: |
          flutter --version
          flutter channel ${{ env.FLUTTER_CHANNEL }}
          flutter upgrade

      - name: Setup Flutter (download)
        if: steps.check_flutter.outputs.flutter_installed == 'false'
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - run: flutter pub get

      - name: Build
        run: |
          MSG="${{ needs.prepare.outputs.message }}"
          if echo "$MSG" | grep -q "android-ios"; then
            make build-appbundle-staging
            make build-android-staging
            make build-ipa-staging
          elif echo "$MSG" | grep -q "android"; then
            make build-appbundle-staging
            make build-android-staging
          elif echo "$MSG" | grep -q "ios"; then
            make build-ipa-staging
          else
            exit 0
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: build-staging-artifacts
          path: |
            build/app/outputs/**/*.aab
            build/ios/ipa/*.ipa

  deploy-staging:
    name: Deploy (staging)
    needs: build-staging
    environment: staging
    runs-on: [self-hosted, macos]
    if: needs.prepare.outputs.should_run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-staging-artifacts

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - run: gem install bundler && bundle install || true

      - name: Deploy via Fastlane
        env:
          ENVIRONMENT: staging
          FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          FIREBASE_IOS_APP_ID: ${{ secrets.FIREBASE_IOS_APP_ID }}
        run: |
          MSG="${{ needs.prepare.outputs.message }}"
          if echo "$MSG" | grep -q "android"; then
            cd android && bundle exec fastlane android deploy environment:staging
          fi
          if echo "$MSG" | grep -q "ios"; then
            cd ios && bundle exec fastlane ios deploy environment:staging
          fi

  # ============= PROD =============
  build-prod:
    name: Build (prod)
    needs: prepare
    environment: prod
    runs-on: [self-hosted, macos]
    if: needs.prepare.outputs.should_run == 'true' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v4
      - name: Check Flutter installed
        id: check_flutter
        run: |
          if command -v flutter &> /dev/null; then
            echo "flutter_installed=true" >> $GITHUB_OUTPUT
            echo "✓ Flutter đã được cài đặt sẵn trên runner"
          else
            echo "flutter_installed=false" >> $GITHUB_OUTPUT
            echo "⚠ Flutter chưa có trên runner"
          fi

      - name: Setup Flutter (from runner)
        if: steps.check_flutter.outputs.flutter_installed == 'true'
        run: |
          flutter --version
          flutter channel ${{ env.FLUTTER_CHANNEL }}
          flutter upgrade

      - name: Setup Flutter (download)
        if: steps.check_flutter.outputs.flutter_installed == 'false'
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - run: flutter pub get

      - name: Build
        run: |
          MSG="${{ needs.prepare.outputs.message }}"
          if echo "$MSG" | grep -q "android-ios"; then
            make build-appbundle-prod
            make build-android-prod
            make build-ipa-prod
          elif echo "$MSG" | grep -q "android"; then
            make build-appbundle-prod
            make build-android-prod
          elif echo "$MSG" | grep -q "ios"; then
            make build-ipa-prod
          else
            exit 0
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: build-prod-artifacts
          path: |
            build/app/outputs/**/*.aab
            build/ios/ipa/*.ipa

  deploy-prod:
    name: Deploy (prod)
    needs: build-prod
    environment: prod
    runs-on: [self-hosted, macos]
    if: needs.prepare.outputs.should_run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-prod-artifacts

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - run: gem install bundler && bundle install || true

      - name: Deploy via Fastlane
        env:
          ENVIRONMENT: prod
          FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          FIREBASE_IOS_APP_ID: ${{ secrets.FIREBASE_IOS_APP_ID }}
        run: |
          MSG="${{ needs.prepare.outputs.message }}"
          if echo "$MSG" | grep -q "android"; then
            cd android && bundle exec fastlane android deploy environment:prod
          fi
          if echo "$MSG" | grep -q "ios"; then
            cd ios && bundle exec fastlane ios deploy environment:prod
          fi
