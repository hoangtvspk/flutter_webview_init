name: Build & Deploy (on branch push with "deploy" in commit)

on:
  workflow_call:
    # Cần định nghĩa inputs/outputs để truyền dữ liệu từ ci.yml
    outputs:
      should_run:
        description: "True if the commit message contains 'deploy'"
        value: ${{ jobs.prepare.outputs.should_run }}
      message:
        description: "The commit message"
        value: ${{ jobs.prepare.outputs.message }}
    inputs:
      commit_message:
        required: true
        type: string
      commit_sha:
        required: true
        type: string # Cần SHA để checkout đúng commit

env:
  FLUTTER_CHANNEL: stable
  FASTLANE_HIDE_TIMESTAMP: "true"
  FASTLANE_SKIP_UPDATE_CHECK: "true"
  FASTLANE_DEBUG: "true"

jobs:
  prepare:
    name: Prepare (common artifacts/cache)
    runs-on: [self-hosted, macos]
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      message: ${{ steps.check.outputs.message }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check commit message contains 'deploy'
        id: check
        run: |
          MSG="${{ github.event.head_commit.message || '' }}"
          echo "Commit: $MSG"
          if echo "$MSG" | grep -q "deploy"; then
            echo "::set-output name=should_run::true"
            echo "::set-output name=message::$MSG"
          else
            echo "::set-output name=should_run::false"
            echo "::set-output name=message::$MSG"
            echo "Commit message does not contain 'deploy' => skipping build/deploy"
          fi

      - name: Check Flutter installed
        if: steps.check.outputs.should_run == 'true'
        id: check_flutter
        run: |
          if command -v flutter &> /dev/null; then
            echo "flutter_installed=true" >> $GITHUB_OUTPUT
            echo "✓ Flutter đã được cài đặt sẵn trên runner"
          else
            echo "flutter_installed=false" >> $GITHUB_OUTPUT
            echo "⚠ Flutter chưa có trên runner"
          fi

      - name: Setup Flutter (download)
        if: steps.check.outputs.should_run == 'true' && steps.check_flutter.outputs.flutter_installed == 'false'
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Prepare env files, google play json & keystore
        if: steps.check.outputs.should_run == 'true'
        env:
          ENV_DEV_CONTENT: ${{ secrets.ENV_DEV_CONTENT }}
          ENV_STAGING_CONTENT: ${{ secrets.ENV_STAGING_CONTENT }}
          ENV_PROD_CONTENT: ${{ secrets.ENV_PROD_CONTENT }}
          GOOGLE_PLAY_JSON: ${{ secrets.GOOGLE_PLAY_JSON }}
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          mkdir -p lib/config

          echo "$ENV_DEV_CONTENT" > lib/config/.env.dev
          echo "$ENV_STAGING_CONTENT" > lib/config/.env.staging
          echo "$ENV_PROD_CONTENT" > lib/config/.env.prod

          if [[ -n "$GOOGLE_PLAY_JSON" ]]; then
            if [[ $(echo "$GOOGLE_PLAY_JSON" | tr -d '[:space:]' | cut -c1) == "{" ]]; then
              echo "$GOOGLE_PLAY_JSON" > google-play-service-account.json
            else
              cp "$GOOGLE_PLAY_JSON" google-play-service-account.json || true
            fi
          fi

          if [[ -n "$KEYSTORE_BASE64" ]]; then
            mkdir -p android/app
            echo "$KEYSTORE_BASE64" | base64 -d > android/app/app-release-key.jks

            echo "storePassword=$KEYSTORE_PASSWORD" > android/key.properties
            echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
            echo "keyAlias=$KEY_ALIAS" >> android/key.properties
            echo "storeFile=app-release-key.jks" >> android/key.properties
          fi

      - name: Log secrets (masked)
        if: steps.check.outputs.should_run == 'true'
        env:
          ENV_DEV_CONTENT: ${{ secrets.ENV_DEV_CONTENT }}
          ENV_STAGING_CONTENT: ${{ secrets.ENV_STAGING_CONTENT }}
          ENV_PROD_CONTENT: ${{ secrets.ENV_PROD_CONTENT }}
          GOOGLE_PLAY_JSON: ${{ secrets.GOOGLE_PLAY_JSON }}
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "ENV_DEV_CONTENT length: ${#ENV_DEV_CONTENT}"
          echo "ENV_STAGING_CONTENT length: ${#ENV_STAGING_CONTENT}"
          echo "ENV_PROD_CONTENT length: ${#ENV_PROD_CONTENT}"
          echo "GOOGLE_PLAY_JSON present: $([[ -n "$GOOGLE_PLAY_JSON" ]] && echo yes || echo no)"
          echo "KEYSTORE_BASE64 length: $(echo -n "$KEYSTORE_BASE64" | wc -c)"
          echo "KEYSTORE_PASSWORD length: ${#KEYSTORE_PASSWORD}"
          echo "KEY_PASSWORD length: ${#KEY_PASSWORD}"
          echo "KEY_ALIAS length: ${#KEY_ALIAS}"

      - name: Debug prepared files
        if: steps.check.outputs.should_run == 'true'
        run: |
          echo "Workspace: $(pwd)"
          ls -lah lib/config || true
          ls -lah android || true
          ls -lah android/app || true

      - name: Upload prepare artifacts
        if: steps.check.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: prepare-artifacts
          include-hidden-files: true
          if-no-files-found: error
          path: |
            lib/config/.env.dev
            lib/config/.env.staging
            lib/config/.env.prod
            google-play-service-account.json
            android/app/app-release-key.jks
            android/key.properties

  # ============= DEV =============
  build-dev:
    name: Build (dev)
    needs: prepare
    environment: dev
    runs-on: [self-hosted, macos]
    if: needs.prepare.outputs.should_run == 'true' && github.ref == 'refs/heads/dev'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: prepare-artifacts

      - name: Debug signing files (dev)
        run: |
          echo "Workspace: $(pwd)"
          ls -lah lib/config || true
          ls -lah android || true
          ls -lah android/app || true

      - run: flutter pub get

      - name: Build
        run: |
          MSG="${{ needs.prepare.outputs.message }}"
          echo "Building for: $MSG"
          if echo "$MSG" | grep -q "android-ios"; then
            make build-appbundle-dev
            make build-android-dev
            make build-ipa-dev
          elif echo "$MSG" | grep -q "android"; then
            make build-appbundle-dev
            make build-android-dev
          elif echo "$MSG" | grep -q "ios"; then
            make build-ipa-dev
          else
            echo "No platform in commit message => skip"
            exit 0
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: build-dev-artifacts
          path: |
            build/app/outputs/**/*.aab
            build/app/outputs/**/*.apk
            build/ios/ipa/*.ipa
            lib/config/.env.dev
            lib/config/.env.staging
            lib/config/.env.prod
            google-play-service-account.json
            android/app/app-release-key.jks
            android/key.properties

  deploy-dev:
    name: Deploy (dev)
    needs: [prepare, build-dev]
    environment: dev
    runs-on: [self-hosted, macos]
    if: needs.prepare.outputs.should_run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-dev-artifacts

      - name: Debug downloaded Android artifacts
        run: |
          echo "Workspace after download: $(pwd)"
          ls -lah build/app/outputs || true
          ls -lah build/app/outputs/flutter-apk || true
          ls -lah app/outputs || true
          ls -lah app/outputs/flutter-apk || true

      - name: Install bundler (system Ruby)
        run: |
          ruby -v
          gem install bundler --user-install || gem install bundler
          echo "$(ruby -e 'print Gem.user_dir')/bin" >> "$GITHUB_PATH"

      - name: Deploy via Fastlane
        env:
          ENVIRONMENT: dev
          FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          FIREBASE_IOS_APP_ID: ${{ secrets.FIREBASE_IOS_APP_ID }}
        run: |
          set -ex
          MSG="${{ needs.prepare.outputs.message }}"
          echo "Deploy message: $MSG"

          if echo "$MSG" | grep -q "android"; then
            cd android
            bundle _2.7.2_ config set --local path vendor/bundle
            bundle _2.7.2_ install --jobs 4 --retry 3
            bundle _2.7.2_ exec fastlane android deploy environment:dev --verbose
            cd -
          else
            echo "Skip Android deploy: message missing 'android'"
          fi

          if echo "$MSG" | grep -q "ios"; then
            cd ios
            bundle _2.7.2_ config set --local path vendor/bundle
            bundle _2.7.2_ install --jobs 4 --retry 3
            bundle _2.7.2_ exec fastlane ios deploy environment:dev --verbose
            cd -
          else
            echo "Skip iOS deploy: message missing 'ios'"
          fi

  # ============= STAGING =============
  build-staging:
    name: Build (staging)
    needs: prepare
    environment: staging
    runs-on: [self-hosted, macos]
    if: needs.prepare.outputs.should_run == 'true' && github.ref == 'refs/heads/staging'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: prepare-artifacts

      - name: Debug signing files (staging)
        run: |
          echo "Workspace: $(pwd)"
          ls -lah android || true
          ls -lah android/app || true
          ls -lah android/key.properties || true
          ls -lah android/app/app-release-key.jks || true

      - run: flutter pub get

      - name: Build
        run: |
          MSG="${{ needs.prepare.outputs.message }}"
          if echo "$MSG" | grep -q "android-ios"; then
            make build-appbundle-staging
            make build-android-staging
            make build-ipa-staging
          elif echo "$MSG" | grep -q "android"; then
            make build-appbundle-staging
            make build-android-staging
          elif echo "$MSG" | grep -q "ios"; then
            make build-ipa-staging
          else
            exit 0
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: build-staging-artifacts
          path: |
            build/app/outputs/**/*.aab
            build/ios/ipa/*.ipa

  deploy-staging:
    name: Deploy (staging)
    needs: build-staging
    environment: staging
    runs-on: [self-hosted, macos]
    if: needs.prepare.outputs.should_run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-staging-artifacts

      - name: Install bundler (system Ruby)
        run: |
          ruby -v
          gem install bundler --user-install || gem install bundler
          echo "$(ruby -e 'print Gem.user_dir')/bin" >> "$GITHUB_PATH"

      - name: Deploy via Fastlane
        env:
          ENVIRONMENT: staging
          FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          FIREBASE_IOS_APP_ID: ${{ secrets.FIREBASE_IOS_APP_ID }}
        run: |
          MSG="${{ needs.prepare.outputs.message }}"
          if echo "$MSG" | grep -q "android"; then
            cd android
            bundle _2.7.2_ config set --local path vendor/bundle
            bundle _2.7.2_ install --jobs 4 --retry 3
            bundle _2.7.2_ exec fastlane android deploy environment:staging --verbose
          fi
          if echo "$MSG" | grep -q "ios"; then
            cd ios
            bundle _2.7.2_ config set --local path vendor/bundle
            bundle _2.7.2_ install --jobs 4 --retry 3
            bundle _2.7.2_ exec fastlane ios deploy environment:staging --verbose
          fi

  # ============= PROD =============
  build-prod:
    name: Build (prod)
    needs: prepare
    environment: prod
    runs-on: [self-hosted, macos]
    if: needs.prepare.outputs.should_run == 'true' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: prepare-artifacts

      - name: Debug signing files (prod)
        run: |
          echo "Workspace: $(pwd)"
          ls -lah android || true
          ls -lah android/app || true
          ls -lah android/key.properties || true
          ls -lah android/app/app-release-key.jks || true

      - run: flutter pub get

      - name: Build
        run: |
          MSG="${{ needs.prepare.outputs.message }}"
          if echo "$MSG" | grep -q "android-ios"; then
            make build-appbundle-prod
            make build-android-prod
            make build-ipa-prod
          elif echo "$MSG" | grep -q "android"; then
            make build-appbundle-prod
            make build-android-prod
          elif echo "$MSG" | grep -q "ios"; then
            make build-ipa-prod
          else
            exit 0
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: build-prod-artifacts
          path: |
            build/app/outputs/**/*.aab
            build/ios/ipa/*.ipa

  deploy-prod:
    name: Deploy (prod)
    needs: build-prod
    environment: prod
    runs-on: [self-hosted, macos]
    if: needs.prepare.outputs.should_run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-prod-artifacts

      - name: Install bundler (system Ruby)
        run: |
          ruby -v
          gem install bundler --user-install || gem install bundler
          echo "$(ruby -e 'print Gem.user_dir')/bin" >> "$GITHUB_PATH"

      - name: Deploy via Fastlane
        env:
          ENVIRONMENT: prod
          FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          FIREBASE_IOS_APP_ID: ${{ secrets.FIREBASE_IOS_APP_ID }}
        run: |
          MSG="${{ needs.prepare.outputs.message }}"
          if echo "$MSG" | grep -q "android"; then
            cd android
            bundle _2.7.2_ config set --local path vendor/bundle
            bundle _2.7.2_ install --jobs 4 --retry 3
            bundle _2.7.2_ exec fastlane android deploy environment:prod --verbose
          fi
          if echo "$MSG" | grep -q "ios"; then
            cd ios
            bundle _2.7.2_ config set --local path vendor/bundle
            bundle _2.7.2_ install --jobs 4 --retry 3
            bundle _2.7.2_ exec fastlane ios deploy environment:prod --verbose
          fi
